<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Chapter 19 - MoonPear</title>
	<link rel="stylesheet" type="text/css" href="../libs/style.css">
	<script src="../libs/run_prettify.js?autoload=true&amp;lang=css" defer=""></script>
	<script type="text/javascript" src="../libs/three.js"></script>
	<script type = "text/javascript" src = "../libs/dat.gui.js"></script>
	<script src = "../libs/OrbitControls.js"></script>
	<script src = "../libs/WebGeometry.js"></script>
	<script src = "../libs/polyhedron.js"></script>
	<script src = "moon_pear_verts.js"></script>
	<script src = "moon_pear.js"></script>
	
	<style>
		#div_out_big
		{
			position: relative;
			width: 1075px;
			height: 525px;
			left: 0px;
			background-color: #aaffff;
			border: solid 2px;
		}
		#div_in_big
		{
			position: absolute;
			left: 5px;
			top: 5px;			
			height: 410px;
			width: 1145px;
			background-color: #eeffee;
			border: solid 2px;
		}
		#div_pars_big
		{
			position: absolute;
			left: 530px;
			top: 2px;			
			height: 515px;
			width: 280px;
			background-color: #eeeeaa;
			border: solid 2px;
		}
		#gui_container_big
		{
			position: absolute;
			left: 820px;
			top: 5px;
		}
	</style>
</head>

<body>

<h3 align = "center">&emsp;&emsp;
<a href="../Pear/Chapter_18.html"> <span class=brown>Глава 18 </span></a>  <span class=brown>&ensp;◄</span>
&emsp;&emsp;&emsp;
<a href="../index.html"> <span class=brown> Содержание  </span></a>
&emsp;&emsp;&emsp;
 <span class=brown>► &ensp;</span><a href="../Heart/Chapter_20.html"> <span class=brown> Глава 20  </span></a>
</h3>

<h2 align = "center"> Three.js и геометрия.  &ensp; Глава 19. &ensp; Груша с лунными гранями (<em>MoonPear</em>)</h2>

<p align="center">В данном разделе мы создадим модель 
<b><a href="http://diamond3d.ucoz.ru/MoonPear/MoonPear_wireframe_trackball.html" 
target="_blank">груши с лунными гранями</a></b>.
</p>

<br>
<div id="div_out_big"> 
		<canvas id="canvas" width="522" height="522" style="border: 1px solid"></canvas>
		<div id="div_pars_big" >
			<canvas id="canvas_pars" width="280" height="480"></canvas>

			<div id="div_input1">
				<input type="radio" name="numeration" id = "btn_no"  />No
				&nbsp;&nbsp;&nbsp; <input type="radio" name="numeration" id = "btn_all" />All
				&nbsp;&nbsp;&nbsp;&nbsp; <input type="radio" name="numeration" id = "btn_cr_gd_pav"  />Cr-Gd-Pav
			</div>		
		</div>
		<div id="gui_container_big" ></div> 
</div>
<h3 align = "center"> Нумерация вершин и обозначение граней модели </h3>

<p>
На рисунке <b>1</b> приведена нумерация вершин павильона груши с лунными гранями. 
Корона огранки и нумерация ее вершин совпадает с короной огранки груша без лунных граней.
</p>

<img src = "enumeration_moon_pear.png" class="center-img-rounded" border = "1px" >

<h3 align = "center"> Структура данных модели (<b>СДМ</b>) огранки  </h3>

&nbsp; &nbsp; Структура данных модели содержит следующие параметры:
<pre class="prettyprint" id="quine">
var lw = 1.5;               // Отношение длины огранки к ее ширине 

     // Форма и толщиа рундиста
var r = 0.04;               // Толщина рундиста
var vp = 0.0;               // Угол, определяющий величину отклонения кривой от окружности
var Lh = 0.34;              // отклонение смещения самого широкого места рундиста 
var square_deviation = 0;   // степень отклонения рундиста от эллипса

     // Корона
var beta = 35*DEGREE;       // Угол короны
var t = 0.6;                // Ширина площадки
var dSquare = 0.0;          // Задает положение средних вершин короны.
var vLh = 0.00001;          // определяет смещение центральной точки огранки
// Павильон
var hp = 0.44;                   // Задает глубину павильона
var hPavFacet = 0.8;             // Определяет положение нижних вершин клиньев павильона
var CuletX = 0.0001;             // смещение калетты вдоль оси X
var MoonFacetAngle = 64*DEGREE;  // угол наклона лунных граней
var MoonRotateAngle = 17*DEGREE; // угол наклона плоскости пересекающей лунные грани
     // Следующие параметры задают положение узловых вершин на рундисте
var DelAngGirdle_4 = 0;            // вершины  рундиста 44, 52, 108, 116
var DelAngGirdle_8 = 0.0*DEGREE;   // вершины  рундиста 40, 56, 104, 120
var DelAngGirdle_12 = 0.0*DEGREE;  // вершины  рундиста 36, 60, 100, 124
var DelAngGd_16 = -2.0*DEGREE;     // вершины  рундиста  0, 32,  64,  96
var DelAngGirdle_20 = 0.0*DEGREE;  // вершины  рундиста  4, 28,  68,  92
var DelAngGirdle_24 = 0.0*DEGREE;  // вершины  рундиста  8, 24,  72,  88
var DelAngGirdle_28 = 0.0*DEGREE;  // вершины  рундиста 12, 20,  76,  84
</pre>

<h3 align = "center"> Расчет положения вершин огранки  </h3>
<p>
Расчет положения вершин рундиста рассматривался ранее. Но, после того как он был расчитан, 
мы развернули его в горизонтальной плоскости таким образом, 
чтобы основной диаметр рундиста был направлен вдоль оси <b>OY</b> (разворот на 90°).
Таким образом, например, вершина рундиста <b>16</b> из предыдущей главы превратилась в вершину рундиста с номером <b>0</b>. 
Построение короны совпадает с построением короны огранки груша без лунных граней.
Рассмотрим построение павильона.
</p>
<p> 
У огранок типа груша, также как и у огранок типа маркиз, может присутствовать примыкающий 
к рундисту пояс лунных граней (<em>moon facets</em>). Также как и огранки маркиз, огранки груша могут 
иметь различное число главных четырехугольных граней павильона. На рисунке <b>1</b> показан вариант огранки 
груша с лунными гранями, которая имеет восемь основных граней павильона. 
</p>
<p>
Лунные грани огранки построены тем же способом, каким построены лунные грани огранки маркиз. 
Отличие заключается только в том, что в качестве оси вращения плоскости <b>planePitch</b> выбирается 
прямая соединяющая вершины рундиста <b>76</b> и <b>116</b>. Однако построить основные четырехугольные грани 
павильона таким же образом, как они были построены в огранке маркиз, не удастся. 
Рассмотрим построение граней <b>a, b, c</b> и <b>d</b> павильона. Будем считать, что лунные грани уже созданы. 
Как можно увидеть из рисунка <b>1</b> огранка, которая должна быть построена, имеет <em>WBT</em>-расположение граней павильона.
</p>
<p>
Прежде всего, находим координаты калетты огранки. Глубина калетты задается при помощи поля <code>hp</code> из <b>СДМ</b>. 
В огранке груша с лунными гранями калетту, в отличие от огранки без лунных граней, можно двигать только вдоль оси <b>OX</b>. 
Смещение калетты задается при помощи двух параметров. 
Параметр vLh сдвигает одновременно и калетту и точку, в которой сходятся плоскости главных граней короны. 
Следует заметить, что при изменении этого параметра положение лунных граней огранки остается неизменным.
Параметр <b>CuletX</b> позволяет двигать вдоль оси <b>OX</b> только калетту – положение граней короны и лунных граней 
павильона остается неизменным. Координаты калетты по оси <b>OY</b> определяются при этом суммой 
значений задаваемых параметрами <b>vLh</b> и <b>CuletX</b>.
</p>
<p>
Для нахождения уравнения плоскости, в которой лежит грань <b>d</b>, поступим следующим образом. 
Из рисунка <b>1</b> видно, что эта плоскость проходит через вершину <b>76</b> и калетту огранки. Координаты этих двух вершин известны. 
Чтобы найти уравнение плоскости требуется определить координаты еще одной точки, 
принадлежащей этой плоскости или каким-то образом задать азимут грани <b>d</b>. 
Можно, конечно явно задать азимут, введя его значение в качестве параметра огранки. 
Но в этом случае при изменении удлинения огранки азимут грани будет оставаться постоянным, 
а желательно, чтобы он менялся в соответствии с изменением удлинения огранки. 
Поэтому требуется найти возможность связать азимут грани <b>d</b> с изменением формы рундиста огранки. 
Так как каждой точке линии рундиста можно поставить в соответствие касательную к этой линии, 
то естественно взять для азимута грани <b>d</b> касательную в некоторой точке рундиста. 
Вместо касательной к рундисту для задания азимута грани подойдет и прямая проходящая через соседние 
или недалеко друг от друга расположенные две вершины рундиста. 
Вопрос заключается только в выборе точек на рундисте, через которые следует провести секущие прямые. 
Сразу напрашивается вариант проведения секущей прямой через вершины <b>75</b> и <b>77</b>. 
Проведенная через эти вершины секущая прямая фактически будет определять направление касательной 
к рундисту в его вершине <b>76</b>. Однако если построить огранку с таким выбором касательной и, 
следовательно, с соответствующим азимутом грани <b>d</b>, 
то результат получится не очень хороший – павильон огранки теряет выпуклость.
</p>
<p> 
Методом подбора было выяснено, что удовлетворительный результат получается, 
если провести секущую прямую через вершины <b>77</b> и <b>78</b> рундиста. В этом случае вектор, 
совпадающий по направлению с этой прямой, задаст азимут грани <b>d</b>. Вершина <b>12</b> павильона принадлежит 
одновременно трем плоскостям – плоскости симметрии огранки <b>OXZ</b>, 
горизонтальной плоскости <b>planePavFacets</b>, определяющей глубину нижних вершин клиньев павильона и плоскости, 
в которой расположена грань <b>d</b>. Поэтому найдем положение вершины <b>12</b> павильона 
как точку пересечения этих трех плоскостей.
</p>
<p>
Перейдем к нахождению координат вершины <b>11</b> павильона. Сделаем следующее допущение – будем считать, 
что эта вершина лежит на вертикальной плоскости, проходящей через калетту огранки,
и вершину <b>72</b> рундиста, координаты которой были определены в процессе построения пояса лунных граней огранки. 
Тогда положение вершины <b>11</b> павильона находится как точка пересечения трех плоскостей – плоскости грани <b>d</b>, 
плоскости <b>planePavFacets</b> и только что упомянутой вертикальной плоскости. 
Теперь, вычислив координаты вершины <b>11</b> павильона, можно записать уравнение плоскости грани <b>c</b>.
</p>
<p>
Таким образом, мы вычислили положение вершин <b>11</b> и <b>12</b> павильона, и нашли уравнения его плоскостей, 
в которых лежат грани <b>c</b> и <b>d</b>. Координаты вершин <b>16</b> и <b>17</b> павильона определяются похожим способом. 
Азимут грани <b>a</b> задает секущая прямая проходящая через вершины рундиста <b>114</b> и <b>118</b>. 
Вершина <b>17</b> павильона лежит на вертикальной плоскости, проходящей через калетту огранки, 
и вершину <b>120</b> рундиста. На последнем этапе построения находим координаты вершины <b>10</b> павильона, 
как точку пересечения плоскостей, в которых лежат грани <b>b</b> и <b>c</b>, а также плоскости <b>planePavFacets</b>. 
</p>
Приведенный вариант построения граней <b>a, b, c</b> и <b>d</b> павильона не является единственно возможным. 
Например, можно определить азимуты граней <b>b</b> и <b>c</b> также как и граней <b>a</b> и <b>d</b> – с помощью проведения 
секущих прямых через выбранные вершины рундиста и затем использовать направляющие векторы этих прямых 
для нахождения уравнений плоскостей, в которых лежат грани.  
В этом случае положение вершины <b>11</b> павильона будет определять точка пересечения плоскостей, 
в которых лежат грани <b>c</b> и <b>d</b> с плоскостью <b>planePavFacets</b>. Положение вершины <b>17</b> павильона будет 
определять точка пересечения плоскостей, в которых лежат грани <b>a</b> и <b>b</b> с той же плоскостью <b>planePavFacets</b>.
<p>
Иногда может потребоваться изменить положение вершин граней <b>d</b> и <b>e</b> лежащих на рундисте (вершины <b>76</b> и <b>84</b>) 
таким образом, чтобы остальные грани павильона не претерпели изменений. 
Для того чтобы осуществить такую возможность требуется убрать ребро соединяющее 
вершины <b>76</b> и <b>12</b> рундиста (рис.<b>2</b>), а также с другой стороны огранки – ребро соединяющее вершины <b>20</b> и <b>84</b> рундиста. 
В результате этого количество граней рундиста уменьшится с <b>64</b> до <b>62</b>, а две грани рундиста 
из четырехугольников превратятся в шестиугольники. 
</p>
<img src = "facets_62.png" class="center-img-rounded" border = "1px" >
<p>
Можно ввести параметр <b>Slide girdle pavilion</b> и соответствующее этому параметру поле <code>slide_girdle_pav</code> в <b>СДМ</b>. 
Параметр позволит двигать вершину <b>76</b> по рундисту таким образом, 
чтобы она могла занимать любое положение между вершинами <b>75</b> и <b>77</b>. 
При желании можно ввести еще один параметр и соответствующее ему поле в <b>СДМ</b> – <code>slide_girdle_crown</code>, 
который позволит задавать положение вершины рундиста <b>12</b> между вершинами <b>11</b> и <b>13</b>. 
Если при изменении параметра <b>DelAngGirdle_28</b> меняется размер сразу восьми сегментов рундиста
примыкающих к носику груши, 
то при изменении параметров задающих значения полей <code>slide_girdle_pav</code> и 
<code>slide_girdle_crown</code> на рундисте будет меняться только положение 
вершины <b>76</b> и (или) вершины <b>12</b>. То, что один сегмент рундиста станет примерно в два раза длиннее, 
не играет большой роли, так как в том месте, где он расположен, рундист имеет наименьшую кривизну. 
Технически эта возможность реализуется следующим образом – после расчета координат вершин рундиста 
с помощью функции <code>InitGirdle</code> рассмотренным ранее способом, 
производится корректировка положения вершин рундиста <b>12</b> и <b>76</b>.
</p>

<p>
Для определения новых значений координат вершин рундиста <b>20</b> и <b>84</b> делается пересчет положения 
вершин точно таким же образом. Величины параметров задающие значения полей <code>slide_girdle_pav</code> 
и <code>slide_girdle_crown</code> будут лежать в пределах от <b>0</b> до <b>1</b>. 
</p>
<pre class="prettyprint" id="quine">
// Расчет положения вершины рундиста 12 (для короны)
girdle[12][0] = girdle[11][0] + slide_girdle_crown * (girdle[13][0] - girdle[11][0]);
girdle[12][1] = girdle[11][1] + slide_girdle_crown * (girdle[13][1] - girdle[11][1]);
girdle[12][2] = data.r/2;
// Расчет положения вершины рундиста 76 (для павильона)
girdle[76][0] = girdle[75][0] + slide_girdle_pav * (girdle[77][0] - girdle[75][0]);
girdle[76][1] = girdle[75][1] + slide_girdle_pav * (girdle[77][1] - girdle[75][1]);
girdle[76][2] = - data.r/2;
</pre>

<h3 align = "center"> Краткое резюме </h3>
<p>
Основной сложностью связанной с построением огранки груша является построение формы рундиста и разбиение рундиста 
на сегменты с возможностью движения по рундисту его вершины <b>16</b>. <em>Напомним</em>, что номер рундиста 
<b>16</b> взят из того раздела, в котором мы рассматривали <em>исключительно</em> построение рундиста.
(Рундист в горизонтальной плоскости, после того как он был расчитан, мы развернули таким образом, 
чтобы основной диаметр рундиста был направлен вдоль оси <b>OY</b> - разворот на <b>90°</b>.) 
В программе этот номер <b>16</b> относится к вершинам  <b>0, 32, 64, 96</b> рундиста, которые 
выводятся на экран по нажатию кнопки <b>Cr-Gd-Pav </b>. 
</p>
<p>
В следующем разделе будет рассмотрено построение огранок типа сердце. 
Рундист огранки сердце представляет собой комбинацию двух рундистов огранки груша. 
Поэтому методика построения рундиста груши и расстановки вершин на ней, будет использована в дальнейшем 
и при построении рундиста огранки сердце.
В данном разделе корона огранки груша была построена практически по той же методике, 
что использовалась при создании огранки бриллиант. В результате этого построения ребра, 
принадлежащие нижним клиньям короны, подходят к рундисту под произвольным углом. 
Однако желательно, чтобы они подходили к рундисту перпендикулярно. 
Если осуществить построение короны, удовлетворяющее этому требованию, то окажется, что оно окажется гораздо более сложным, 
чем построение короны огранок из данного раздела. 
Такой способ построения короны был использован в предыдущем разделе в процессе создания огранки маркиз с лунными гранями. 
Его можно использовать и при построении короны огранок груша. 
При построении огранки сердце (в следующем разделе) корона огранки будет построена 
именно таким образом – когда указанные ребра клиньев короны подходят к рундисту 
всегда под прямым углом – вне зависимости от того какие значения принимают параметры 
определяющие форму и размер рундиста и короны.
</p>

<h3 align = "center">&emsp;&emsp;
<a href="../Pear/Chapter_18.html"> <span class=brown>Глава 18 </span></a>  <span class=brown>&ensp;◄</span>
&emsp;&emsp;&emsp;
<a href="../index.html"> <span class=brown> Содержание  </span></a>
&emsp;&emsp;&emsp;
 <span class=brown>► </span><a href="../Heart/Chapter_20.html"> <span class=brown> Глава 20  </span></a>
</h3>

</body>
</html>
